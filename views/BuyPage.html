<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Buy Book - BookVerse</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* (Styles remain unchanged) */
    body {
      background: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?fm=jpg&q=80&w=3000&ixlib=rb-4.0.3') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
    }
    .book-card {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }
    .book-card img {
      width: 200px;
      height: auto;
      border-radius: 10px;
      margin: 10px;
    }
    .book-details {
      flex: 1;
    }
    .book-details h2 {
      margin: 0 0 10px;
      font-size: 28px;
    }
    .book-details p {
      margin: 5px 0;
      font-size: 16px;
    }
    .buttons {
      margin-top: 15px;
    }
    .buttons button {
      margin-right: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .buy-btn {
      background-color: #28a745;
      color: white;
    }
    .cancel-btn {
      background-color: #dc3545;
      color: white;
    }
    .back-btn {
      background-color: #1876db;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }
    .description {
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Book Card with Cover and Details -->
    <div class="book-card">
      <img id="bookCover" src="/default-book.jpg" alt="Book Cover">
      <div class="book-details">
        <h2 id="bookName">Book Name</h2>
        <p><strong>Author:</strong> <span id="bookAuthor">Author Name</span></p>
        <p><strong>Edition:</strong> <span id="bookEdition">Edition Info</span></p>
        <p><strong>Semester:</strong> <span id="bookSemester">N/A</span></p>
        <p><strong>Department:</strong> <span id="bookDepartment">N/A</span></p>
        <p><strong>Condition:</strong> <span id="bookCondition">N/A</span></p>
        <div class="buttons">
          <!-- Button text shows the sell price value -->
          <button id="buyButton" class="buy-btn" onclick="handleBuy()" >Buy for ₹<span id="bookPrice">0</span></button>
        </div>
      </div>
    </div>
    <!-- Book Description -->
    <div class="description">
      <p id="bookDescription">Book description goes here...</p>
    </div>
    <!-- Back Button -->
    <button class="back-btn" onclick="goBack()">Back</button>
  </div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('id');
    // Retrieve the current user's email from the URL parameter
    const currentUserEmail = urlParams.get('email') || "default@example.com";
    function startCountdown(bidEnd) {
  const countdownElem = document.getElementById('bidCountdown');
  clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    const now = Math.floor(Date.now() / 1000);
    const diff = bidEnd - now;
    if (diff <= 0) {
      clearInterval(countdownInterval);
      // Auction time is up — silently revert auction
      fetch('/user/cancelAuction', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: bookId })
      })
      .then(() => {
        // Refresh UI to show library status
        fetchBookDetails();
      })
      .catch(err => console.error('Error reverting auction:', err));
    } else {
      const days = Math.floor(diff / 86400);
      const hours = Math.floor((diff % 86400) / 3600);
      const minutes = Math.floor((diff % 3600) / 60);
      const seconds = diff % 60;
      countdownElem.textContent = `Time left: ${days}d ${hours}h ${minutes}m ${seconds}s`;
    }
  }, 1000);
}

   // Update button state functions.
   function setBuyButton() {
      const buyBtn = document.getElementById('buyButton');
      const priceText = document.getElementById('bookPrice').textContent;
      buyBtn.textContent = `Buy for ₹${priceText}`;
      buyBtn.className = 'buy-btn';
      console.log("setBuyButton executed:", buyBtn.outerHTML);
    }

    function setCancelButton() {
      const buyBtn = document.getElementById('buyButton');
      buyBtn.textContent = "Cancel Request";
      buyBtn.className = 'cancel-btn';
      console.log("setCancelButton executed:", buyBtn.outerHTML);
    }

    // Fetch book details from backend and update UI.
    function fetchBookDetails() {
      fetch(`/user/book?id=${bookId}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('bookName').textContent = data.book_name;
          document.getElementById('bookAuthor').textContent = data.author;
          document.getElementById('bookEdition').textContent = data.edition || 'N/A';
          document.getElementById('bookSemester').textContent = data.semester || 'N/A';
          document.getElementById('bookDepartment').textContent = data.department || 'N/A';
          document.getElementById('bookCondition').textContent = data.conditions || 'N/A';
          document.getElementById('bookDescription').textContent = data.description || 'No description available';
          document.getElementById('bookCover').src = data.book_cover ? `/uploads/book_covers/${data.book_cover}` : '/default-book.jpg';
          document.getElementById('bookPrice').textContent = data.sell_price ? parseFloat(data.sell_price).toFixed(2) : "0.00";

          // Check the buyer status in the user_requests table.
          fetch(`/user/buyStatus?book_id=${bookId}&buyer_email=${currentUserEmail}`)
            .then(resp => resp.json())
            .then(statusData => {
              if (statusData.buyer_status === 'pending') {
                setCancelButton();
              } else {
                setBuyButton();
              }
            })
            .catch(err => {
              console.error("Error checking buy_status:", err);
              setBuyButton(); // fallback
            });
        })
        .catch(err => console.error('Error fetching book details:', err));
    }

    // When the buy/cancel button is clicked.
    function handleBuy() {
      const buyBtn = document.getElementById('buyButton');
      if (buyBtn.classList.contains('buy-btn')) {
        if (confirm("Are you sure you want to buy this book?")) {
          // Insert a new buy request record into user_requests with buyer_status 'pending'
          fetch('/user/buyBook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: bookId, buyer_email: currentUserEmail })
          })
          .then(response => response.json())
          .then(() => {
            alert("Buy request sent successfully.");
            setCancelButton();
            fetchBookDetails();
          })
          .catch(err => console.error('Error sending buy request:', err));
        }
      } else {
        if (confirm("Are you sure you want to cancel your buy request?")) {
          // Delete the buy request from user_requests table.
          fetch('/user/cancelBuy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: bookId, buyer_email: currentUserEmail })
          })
          .then(response => response.json())
          .then(() => {
            alert("Buy request canceled.");
            window.location.reload();
            fetchBookDetails();
          })
          .catch(err => console.error('Error canceling buy request:', err));
        }
      }
    }

  
    function goBack() {
      window.history.back();
    }
  
    // Refresh book details periodically (e.g., every 10 seconds).
    setInterval(fetchBookDetails, 10000);
    fetchBookDetails();
  </script>
  
  
  
</body>
</html>
