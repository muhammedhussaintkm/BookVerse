<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book Details - BookVerse</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?fm=jpg&q=80&w=3000&ixlib=rb-4.0.3') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
    }
    .book-card {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }
    .book-card img {
      width: 200px;
      height: auto;
      border-radius: 10px;
      margin: 10px;
    }
    .book-details {
      flex: 1;
    }
    .book-details h2 {
      margin: 0 0 10px;
      font-size: 28px;
    }
    .book-details p {
      margin: 5px 0;
      font-size: 16px;
    }
    .buttons {
      margin-top: 15px;
    }
    .buttons button {
      margin-right: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .edit-btn { background-color: #007bff; color: white; }
    .sell-btn { background-color: #28a745; color: white; }
    .auction-btn { background-color: #28a745; color: white; }
    .cancel-btn { background-color: #c53b3b;
      position: absolute;
      right: 20%;
      bottom: 31%;
      color: white;
      padding: 08px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px; }
    .remove-btn { background-color: #dc3545; color: white; }
    .confirm-btn { background-color: #1876db; color: white; }
    .back-btn {
      background-color: #1876db;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .description {
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
    }
    /* Modal styles for Sell and Auction */
    .modal {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, 0);
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 20px;
      z-index: 10;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .modal h3 { margin-top: 0; }
    .modal input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal .btn-group {
      display: flex;
      justify-content: space-between;
    }
    .modal .btn-group button {
      flex: 1;
      margin: 5px;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .hidden { display: none; }
    .countdown { font-weight: bold; color: #d9534f; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Book Card with Cover and Details -->
    <div class="book-card">
      <img id="bookCover" src="/default-book.jpg" alt="Book Cover">
      <div class="book-details">
        <h2 id="bookName">Book Name</h2>
        <p><strong>Author:</strong> <span id="bookAuthor">Author Name</span></p>
        <p><strong>Edition:</strong> <span id="bookEdition">Edition Info</span></p>
        <p><strong>Semester:</strong> <span id="bookSemester">N/A</span></p>
        <p><strong>Department:</strong> <span id="bookDepartment">N/A</span></p>
        <p><strong>Condition:</strong> <span id="bookCondition">N/A</span></p>
        <div class="buttons">
          <button class="edit-btn"  onclick="editBook()">Edit</button>
          <button class="sell-btn" id="sellBtn" onclick="handleSell()">Sell Now</button>
          <button class="auction-btn" id="auctionBtn" onclick="handleAuction()">Auction Now</button>
          <button class="remove-btn" onclick="removeBook()">Remove</button>
        </div>
        <!-- Extra button area for showing cancel buttons -->
        <div id="extraBtnArea"></div>
      </div>
    </div>
    <!-- Auction Info Area: Displays highest bid and countdown timer -->
    <div id="auctionInfo" class="hidden">
      <p><strong>Highest Bid:</strong> $<span id="maxBid">0.00</span></p>
      <p class="countdown" id="bidCountdown"></p>
    </div>
    <!-- Book Description -->
    <div class="description">
      <p id="bookDescription">Book description goes here...</p>
    </div>
    <!-- Back Button -->
    <button class="back-btn" onclick="goBack()">Back</button>

    <!-- Modal for Sell Form -->
    <div id="sellModal" class="modal hidden">
      <h3>Set Sell Price</h3>
      <input type="number" id="sellPriceInput" placeholder="Enter price">
      <div class="btn-group">
        <button style="background-color:#28a745; color:white;" onclick="submitSell()">Submit</button>
        <button style="background-color:#dc3545; color:white;" onclick="closeSellModal()">Close</button>
      </div>
    </div>

    <!-- Modal for Auction Form -->
    <div id="auctionModal" class="modal hidden">
      <h3>Set Auction Details</h3>
      <input type="number" id="minBidInput" placeholder="Enter minimum bid price">
      <div>
        <input type="number" id="bidDaysInput" placeholder="Days" style="width:30%; display:inline-block;">
        <input type="number" id="bidHoursInput" placeholder="Hours" style="width:30%; display:inline-block;">
        <input type="number" id="bidMinutesInput" placeholder="Minutes" style="width:30%; display:inline-block;">
      </div>
      <div class="btn-group">
        <button style="background-color:#28a745; color:white;" onclick="submitAuction()">Submit</button>
        <button style="background-color:#dc3545; color:white;" onclick="closeAuctionModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // 1) Grab bookId and currentUserEmail once
  const urlParams = new URLSearchParams(window.location.search);
  const bookId = urlParams.get('id');
  const currentUserEmail = urlParams.get('email');
  if (!bookId || !currentUserEmail) {
    console.error("Missing book id or user email in URL");
  }

    let currentStatus = '';
    let countdownInterval;
    // Global variables to store auction data for comparison after countdown
    let globalMinBid = 0;
    let globalMaxBid = 0;
    let globalBuyerEmail = '';  // Highest bidder's email, if available

  // 3) Fetch & render
  function fetchBookDetails() {
      fetch(`/user/book?id=${bookId}`)
        .then(res => {
          if (!res.ok) {
            // no such book → back
            window.location.href = `/myBooks?email=${encodeURIComponent(currentUserEmail)}`;
            throw new Error("Book not found, redirecting");
          }
          return res.json();
        })
        .then(data => {
          // Populate fields
          document.getElementById('bookName').textContent = data.book_name;
          document.getElementById('bookAuthor').textContent = data.author;
          document.getElementById('bookEdition').textContent = data.edition||'N/A';
          document.getElementById('bookSemester').textContent = data.semester||'N/A';
          document.getElementById('bookDepartment').textContent = data.department||'N/A';
          document.getElementById('bookCondition').textContent = data.conditions||'N/A';
          document.getElementById('bookDescription').textContent = data.description||'No description';
          document.getElementById('bookCover').src = data.book_cover
            ? `/uploads/book_covers/${data.book_cover}`
            : '/default-book.jpg';
          
          // Set current highest bid (if no bid, fallback to min_bid_price)
          const currentHighestBid = parseFloat(data.max_bid) || 0;
          document.getElementById('maxBid').textContent = currentHighestBid.toFixed(2);
          // Hide Edit during any auction
          const editBtn = document.querySelector('.edit-btn');
          if (data.status.startsWith('auction')) {
            editBtn.style.display = 'none';
          } else {
            editBtn.style.display = 'inline-block';
          }
           
          // If this user has a pending bid/request
          if (data.buyer_id !==null && data.buyer_status === 'pending') {
            document.querySelector('.buttons').style.display = 'none';
            document.getElementById('auctionInfo').classList.add('hidden');
            document.getElementById('extraBtnArea').innerHTML = `
              <div class="auction-complete-message">
                Your Auction is completed with a bid amount ₹${(parseFloat(data.max_bid)||0).toFixed(2)}!<br>
                Waiting for Admin's approval.
              </div>
            `;
          } else {
            document.querySelector('.buttons').style.display = 'flex';
            document.getElementById('extraBtnArea').innerHTML = '';
            updateButtons(data);
          }
        })
        .catch(err => console.error(err));
    }

    // Update buttons based on current book status
    function updateButtons(data) {
      const editBtn = document.querySelector('.edit-btn');
      const sellBtn = document.getElementById('sellBtn');
      const auctionBtn = document.getElementById('auctionBtn');
      const extraBtnArea = document.getElementById('extraBtnArea');
      const auctionInfo = document.getElementById('auctionInfo');
      if (data.status === 'sell_approved') {
    editBtn.style.display = 'none';
  } else {
    editBtn.style.display = 'inline-block';
  }
      // Reset state
      extraBtnArea.innerHTML = '';
      auctionInfo.classList.add('hidden');
      sellBtn.disabled = false;
      auctionBtn.disabled = false;
      sellBtn.style.display = 'inline-block';
      auctionBtn.style.display = 'inline-block';

      if (data.status === 'sell_pending') {
        sellBtn.textContent = 'Cancel Request';
        sellBtn.className = 'cancel-btn';
        auctionBtn.disabled = true;
      } else if (data.status === 'auction_pending') {
        auctionBtn.textContent = 'Cancel Request';
        auctionBtn.className = 'cancel-btn';
        sellBtn.disabled = true;
      } else if (data.status === 'sell_approved') {
        sellBtn.textContent = 'For Sale';
        sellBtn.disabled = true;
        auctionBtn.style.display = 'none';
        extraBtnArea.innerHTML = `<button class="cancel-btn" onclick="cancelSell()">Cancel Sale</button>`;
      } else if (data.status === 'auction_approved') {
        // In auction approved state, show highest bid and timer.
        sellBtn.textContent = 'For Auction';
        sellBtn.disabled = true;
        auctionBtn.disabled = true;
        auctionBtn.style.display = 'none';
        auctionInfo.classList.remove('hidden');
        document.getElementById('maxBid').textContent = globalMaxBid.toFixed(2);
        // Save highest bidder email if provided
        globalBuyerEmail = data.buyer_id || '';
        if (data.bid_end) {
          startCountdown(data.bid_end);
        }
      } else {
        // Default state: normal Sell Now and Auction Now buttons.
        sellBtn.textContent = 'Sell Now';
        sellBtn.className = 'sell-btn';
        auctionBtn.textContent = 'Auction Now';
        auctionBtn.className = 'auction-btn';
      }
    }

    // Countdown timer: when time finishes, determine auction result.
    // bidEnd is assumed to be a UNIX timestamp (in seconds)
    function startCountdown(bidEnd) {
      const countdownElem = document.getElementById('bidCountdown');
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        const now = Math.floor(Date.now() / 1000);
        const diff = bidEnd - now;
        if (diff <= 0) {
          clearInterval(countdownInterval);
          countdownElem.textContent = "Bidding time finished.";
          // After countdown, check if any higher bid was placed.
          if (globalMaxBid === globalMinBid) {
            // Auction did not complete – no higher bid.
            // Automatically revert auction and notify seller.
            rejectAuction();
          } else {
            // Auction completed – mark as sold automatically.
            confirmAuction();
          }
        } else {
          const days = Math.floor(diff / 86400);
          const hours = Math.floor((diff % 86400) / 3600);
          const minutes = Math.floor((diff % 3600) / 60);
          const seconds = diff % 60;
          countdownElem.textContent = `Time left: ${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
      }, 1000);
    }

    // Auction result functions:
    function confirmAuction() {
      // Automatically confirm the sale using highest bid details.
      fetch('/user/confirmSale', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: bookId })
      })
      .then(res => res.json())
      .then(() => {
        alert("Auction completed. Book marked as sold.");
        window.location.href = `/myBooks?email=${encodeURIComponent(currentUserEmail)}`;
      })
      .catch(err => console.error(err));
    }
    function rejectAuction() {
      // Auction not completed; revert auction.
      fetch('/user/rejectSale', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: bookId })
      })
      .then(res => res.json())
      .then(() => {
        // Optionally, add a notification for the seller.
        // Assuming seller's user_id and email are available from book details; here we use uploader_id.
        fetch('/user/addNotification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: bookId, user_email: '', notification: "Auction did not complete – no valid bids." })
        })
        .then(() => {
          alert("Auction not complete. No valid bids. Auction reverted.");
          fetchBookDetails();
        })
        .catch(err => console.error(err));
      })
      .catch(err => console.error(err));
    }

    // Sell modal functions
    function handleSell() {
      const sellBtn = document.getElementById('sellBtn');
      if (sellBtn.textContent.trim() === 'Sell Now') {
        showSellModal();
      } else {
        cancelSell();
      }
    }
    function showSellModal() {
      document.getElementById('sellModal').classList.remove('hidden');
    }
    function closeSellModal() {
      document.getElementById('sellModal').classList.add('hidden');
    }
    function submitSell() {
      const price = document.getElementById('sellPriceInput').value;
      if (!price) {
        alert("Please enter a price.");
        return;
      }
      fetch('/user/setSellPrice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: bookId, sell_price: price })
      })
      .then(res => res.json())
      .then(() => {
        closeSellModal();
        fetchBookDetails();
      })
      .catch(err => console.error(err));
    }
    function cancelSell() {
      if (confirm("Are you sure you want to cancel the sell request?")) {
        fetch('/user/cancelSell', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: bookId })
        })
        .then(res => res.json())
        .then(() => fetchBookDetails())
        .catch(err => console.error(err));
      }
    }

    // Auction modal functions
    function handleAuction() {
      const auctionBtn = document.getElementById('auctionBtn');
      if (auctionBtn.textContent.trim() === 'Auction Now') {
        showAuctionModal();
      } else {
        cancelAuction();
      }
    }
    function showAuctionModal() {
      document.getElementById('auctionModal').classList.remove('hidden');
    }
    function closeAuctionModal() {
      document.getElementById('auctionModal').classList.add('hidden');
    }
    function submitAuction() {
      const minBid = document.getElementById('minBidInput').value;
      const bidDays = document.getElementById('bidDaysInput').value || 0;
      const bidHours = document.getElementById('bidHoursInput').value || 0;
      const bidMinutes = document.getElementById('bidMinutesInput').value || 0;
      if (!minBid) {
        alert("Please enter the minimum bid price.");
        return;
      }
      // Convert days, hours, minutes to seconds.
      const totalSeconds = (parseInt(bidDays) * 86400) + (parseInt(bidHours) * 3600) + (parseInt(bidMinutes) * 60);
      if(totalSeconds <= 0) {
        alert("Please enter a valid bidding period.");
        return;
      }
      fetch('/user/setAuctionDetails', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: bookId, min_bid_price: minBid, bid_period: totalSeconds })
      })
      .then(res => res.json())
      .then(() => {
        closeAuctionModal();
        fetchBookDetails();
      })
      .catch(err => console.error(err));
    }
    function cancelAuction() {
      if (confirm("Are you sure you want to cancel the auction request?")) {
        fetch('/user/cancelAuctionE', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: bookId })
        })
        .then(res => res.json())
        .then(() => fetchBookDetails())
        .catch(err => console.error(err));
      }
    }

    // Other functions
    function editBook() {
      window.location.href = `/editBook?id=${bookId}&email=${encodeURIComponent(currentUserEmail)}`;
    }
    function removeBook() {
      if (confirm('Are you sure you want to remove this book?')) {
        fetch(`/user/removeBook?id=${bookId}&email=${encodeURIComponent(currentUserEmail)}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(() => {
            alert('Book removed successfully');
            window.location.href = `/myBooks?email=${encodeURIComponent(currentUserEmail)}`;
          })
          .catch(err => console.error('Error removing book:', err));
      }
    }
    // 2) Override the Back button
  function goBack() {
    window.location.href = `/myBooks?email=${encodeURIComponent(currentUserEmail)}`;
  }

    // Refresh book details every 10 seconds.
    setInterval(fetchBookDetails, 10000);
    fetchBookDetails();
  </script>
</body>
</html>
