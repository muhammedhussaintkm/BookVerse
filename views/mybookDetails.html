<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book Details - BookVerse</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?fm=jpg&q=80&w=3000&ixlib=rb-4.0.3') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
    }
    .book-card {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }
    .book-card img {
      width: 200px;
      height: auto;
      border-radius: 10px;
      margin: 10px;
    }
    .book-details {
      flex: 1;
    }
    .book-details h2 {
      margin: 0 0 10px;
      font-size: 28px;
    }
    .book-details p {
      margin: 5px 0;
      font-size: 16px;
    }
    .buttons {
      margin-top: 15px;
    }
    .buttons button {
      margin-right: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .edit-btn { background-color: #007bff; color: white; }
    .sell-btn { background-color: #28a745; color: white; }
    .auction-btn { background-color: #28a745; color: white; }
    .cancel-btn { background-color: #c53b3b;
      position: absolute;
      right: 20%;
      bottom: 31%;
      color: white;
      padding: 08px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px; }
    .remove-btn { background-color: #dc3545; color: white; }
    .confirm-btn { background-color: #1876db; color: white; }
    .back-btn {
      background-color: #1876db;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .description {
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
    }
    /* Modal styles for Sell and Auction */
    .modal {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, 0);
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 20px;
      z-index: 10;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .modal h3 { margin-top: 0; }
    .modal input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal .btn-group {
      display: flex;
      justify-content: space-between;
    }
    .modal .btn-group button {
      flex: 1;
      margin: 5px;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .hidden { display: none; }
    .countdown { font-weight: bold; color: #d9534f; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Book Card with Cover and Details -->
    <div class="book-card">
      <img id="bookCover" src="/default-book.jpg" alt="Book Cover">
      <div class="book-details">
        <h2 id="bookName">Book Name</h2>
        <p><strong>Author:</strong> <span id="bookAuthor">Author Name</span></p>
        <p><strong>Edition:</strong> <span id="bookEdition">Edition Info</span></p>
        <p><strong>Semester:</strong> <span id="bookSemester">N/A</span></p>
        <p><strong>Department:</strong> <span id="bookDepartment">N/A</span></p>
        <p><strong>Condition:</strong> <span id="bookCondition">N/A</span></p>
        <div class="buttons">
          <button class="edit-btn" onclick="editBook()">Edit</button>
          <button class="sell-btn" id="sellBtn" onclick="handleSell()">Sell Now</button>
          <button class="auction-btn" id="auctionBtn" onclick="handleAuction()">Auction Now</button>
          <button class="remove-btn" onclick="removeBook()">Remove</button>
        </div>
        <!-- Extra button area for showing cancel buttons -->
        <div id="extraBtnArea"></div>
      </div>
    </div>

    <!-- Auction Info Area: Displays highest bid and countdown timer -->
    <div id="auctionInfo" class="hidden">
      <p><strong>Highest Bid:</strong> $<span id="maxBid">0.00</span></p>
      <p class="countdown" id="bidCountdown"></p>
    </div>
    <!-- Auction Info Area: Displays highest bid and countdown timer -->
    <div id="saleInfo" class="hidden">
      <p><strong>Highest Bid:</strong> $<span id="saleprice">0.00</span></p>
      <p class="countdown" id="bidCountdown"></p>
    </div>

    <!-- Book Description -->
    <div class="description">
      <p id="bookDescription">Book description goes here...</p>
    </div>

    <!-- Back Button -->
    <button class="back-btn" onclick="goBack()">Back</button>

    <!-- Sell Modal -->
    <div id="sellModal" class="modal hidden">
      <h3>Set Sell Price</h3>
      <input type="number" id="sellPriceInput" placeholder="Enter price">
      <div class="btn-group">
        <button style="background-color:#28a745; color:white;" onclick="submitSell()">Submit</button>
        <button style="background-color:#dc3545; color:white;" onclick="closeSellModal()">Close</button>
      </div>
    </div>

    <!-- Auction Modal -->
    <div id="auctionModal" class="modal hidden">
      <h3>Set Auction Details</h3>
      <input type="number" id="minBidInput" placeholder="Enter minimum bid price">
      <div>
        <input type="number" id="bidDaysInput" placeholder="Days" style="width:30%; display:inline-block;">
        <input type="number" id="bidHoursInput" placeholder="Hours" style="width:30%; display:inline-block;">
        <input type="number" id="bidMinutesInput" placeholder="Minutes" style="width:30%; display:inline-block;">
      </div>
      <div class="btn-group">
        <button style="background-color:#28a745; color:white;" onclick="submitAuction()">Submit</button>
        <button style="background-color:#dc3545; color:white;" onclick="closeAuctionModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // 1) Grab bookId and currentUserEmail once
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('id');
    const currentUserEmail = urlParams.get('email');
    if (!bookId || !currentUserEmail) {
      console.error("Missing book id or user email in URL");
    }

    // Globals for auction logic
    let countdownInterval;
    let globalMinBid = 0;
    let globalMaxBid = 0;
    let globalBuyerEmail = '';

    // 3) Fetch & render
    function fetchBookDetails() {
      fetch(`/user/book?id=${bookId}`)
        .then(res => {
          if (!res.ok) {
            window.location.href = `/myBooks?email=${encodeURIComponent(currentUserEmail)}`;
            throw new Error("Book not found, redirecting");
          }
          return res.json();
        })
        .then(data => {
          // Populate fields
          document.getElementById('bookName').textContent = data.book_name;
          document.getElementById('bookAuthor').textContent = data.author;
          document.getElementById('bookEdition').textContent = data.edition || 'N/A';
          document.getElementById('bookSemester').textContent = data.semester || 'N/A';
          document.getElementById('bookDepartment').textContent = data.department || 'N/A';
          document.getElementById('bookCondition').textContent = data.conditions || 'N/A';
          document.getElementById('bookDescription').textContent = data.description || 'No description';
          document.getElementById('bookCover').src = data.book_cover
            ? `/uploads/book_covers/${data.book_cover}`
            : '/default-book.jpg';

          // ─── NEW: initialize our globals from the data ───
          globalMinBid = parseFloat(data.min_bid_price) || 0;
          globalMaxBid = parseFloat(data.max_bid) || globalMinBid;
          document.getElementById('maxBid').textContent = globalMaxBid.toFixed(2);

          // Hide Edit during any auction
          const editBtn = document.querySelector('.edit-btn');
          if (data.status.startsWith('auction')) {
            editBtn.style.display = 'none';
          } else {
            editBtn.style.display = 'inline-block';
          }

          // If this user has a pending bid/request
          if (data.buyer_id !== null && data.buyer_status === 'pending') {
            document.querySelector('.buttons').style.display = 'none';
            document.getElementById('auctionInfo').classList.add('hidden');
            document.getElementById('extraBtnArea').innerHTML = `
              <div class="auction-complete-message">
                Your Auction is completed with a bid amount ₹${globalMaxBid.toFixed(2)}!<br>
                Waiting for Admin's approval.
              </div>
            `;
          } else {
            document.querySelector('.buttons').style.display = 'flex';
            document.getElementById('extraBtnArea').innerHTML = '';
            updateButtons(data);
          }
        })
        .catch(err => console.error(err));
    }

    // Update buttons based on current book status
    function updateButtons(data) {
      const editBtn     = document.querySelector('.edit-btn');
      const sellBtn     = document.getElementById('sellBtn');
      const auctionBtn  = document.getElementById('auctionBtn');
      const extraBtnArea= document.getElementById('extraBtnArea');
      const auctionInfo = document.getElementById('auctionInfo');

      // Reset state
      extraBtnArea.innerHTML = '';
      auctionInfo.classList.add('hidden');
      sellBtn.disabled = auctionBtn.disabled = false;
      sellBtn.style.display = auctionBtn.style.display = 'inline-block';

      // Adjust per-status
      if (data.status === 'sell_pending') {
        sellBtn.textContent = 'Cancel Request';
        sellBtn.className = 'cancel-btn';
        auctionBtn.disabled = true;

      } else if (data.status === 'auction_pending') {
        auctionBtn.textContent = 'Cancel Request';
        auctionBtn.className = 'cancel-btn';
        sellBtn.disabled = true;

      } else if (data.status === 'sell_approved') {
        document.querySelector('.edit-btn').style.display = 'none';
        sellBtn.textContent = 'For Sale';
        sellBtn.disabled = true;
        auctionBtn.style.display = 'none';
        extraBtnArea.innerHTML = `<button class="cancel-btn" onclick="cancelSell()">Cancel Sale</button>`;

      } else if (data.status === 'auction_approved') {
        // Show highest bid and timer.
        sellBtn.textContent = 'For Auction';
        sellBtn.disabled = auctionBtn.disabled = true;
        auctionBtn.style.display = 'none';
        auctionInfo.classList.remove('hidden');
        document.getElementById('maxBid').textContent = globalMaxBid.toFixed(2);
        globalBuyerEmail = data.buyer_id || '';
        if (data.bid_end) startCountdown(data.bid_end);

      } else {
        // Default
        sellBtn.textContent = 'Sell Now';
        sellBtn.className = 'sell-btn';
        auctionBtn.textContent = 'Auction Now';
        auctionBtn.className = 'auction-btn';
      }
    }

    // Countdown timer
    function startCountdown(bidEnd) {
      const countdownElem = document.getElementById('bidCountdown');
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        const now  = Math.floor(Date.now()/1000);
        const diff = bidEnd - now;
        if (diff <= 0) {
          clearInterval(countdownInterval);
          countdownElem.textContent = "Bidding time finished.";
          if (globalMaxBid === globalMinBid) rejectAuction();
          else confirmAuction();
        } else {
          const d = Math.floor(diff/86400);
          const h = Math.floor((diff%86400)/3600);
          const m = Math.floor((diff%3600)/60);
          const s = diff%60;
          countdownElem.textContent = `Time left: ${d}d ${h}h ${m}m ${s}s`;
        }
      }, 1000);
    }

    // Auction result handlers
    function confirmAuction() {
      fetch('/user/confirmSale', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: bookId })
      })
      .then(r=>r.json())
      .then(()=>{
        alert("Auction completed. Book marked as sold.");
        window.location.href = `/myBooks?email=${encodeURIComponent(currentUserEmail)}`;
      })
      .catch(console.error);
    }
    function rejectAuction() {
      fetch('/user/rejectSale', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: bookId })
      })
      .then(r=>r.json())
      .then(()=>{
        alert("Auction did not complete – no valid bids.");
        fetchBookDetails();
      })
      .catch(console.error);
    }

    // Sell modal
    function handleSell() {
      const btn = document.getElementById('sellBtn');
      btn.textContent.trim()==='Sell Now' ? showSellModal() : cancelSell();
    }
    function showSellModal()   { document.getElementById('sellModal').classList.remove('hidden'); }
    function closeSellModal()  { document.getElementById('sellModal').classList.add('hidden'); }
    function submitSell() {
      const price = document.getElementById('sellPriceInput').value;
      if (!price) return alert("Please enter a price.");
      fetch('/user/setSellPrice', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: bookId, sell_price: price })
      })
      .then(r=>r.json())
      .then(()=>{
        closeSellModal();
        fetchBookDetails();
      })
      .catch(console.error);
    }
    function cancelSell() {
      if (!confirm("Cancel sell request?")) return;
      fetch('/user/cancelSell', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: bookId })
      })
      .then(r=>r.json())
      .then(fetchBookDetails)
      .catch(console.error);
    }

    // Auction modal
    function handleAuction() {
      const btn = document.getElementById('auctionBtn');
      btn.textContent.trim()==='Auction Now' ? showAuctionModal() : cancelAuction();
    }
    function showAuctionModal()   { document.getElementById('auctionModal').classList.remove('hidden'); }
    function closeAuctionModal()  { document.getElementById('auctionModal').classList.add('hidden'); }
    function submitAuction() {
      const minBid = document.getElementById('minBidInput').value;
      const d = parseInt(document.getElementById('bidDaysInput').value)    || 0;
      const h = parseInt(document.getElementById('bidHoursInput').value)   || 0;
      const m = parseInt(document.getElementById('bidMinutesInput').value) || 0;
      if (!minBid) return alert("Please enter the minimum bid price.");
      const totalSec = d*86400 + h*3600 + m*60;
      if (totalSec<=0) return alert("Please enter a valid bidding period.");
      fetch('/user/setAuctionDetails', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: bookId, min_bid_price: minBid, bid_period: totalSec })
      })
      .then(r=>r.json())
      .then(()=>{
        closeAuctionModal();
        fetchBookDetails();
      })
      .catch(console.error);
    }
    function cancelAuction() {
      if (!confirm("Cancel auction request?")) return;
      fetch('/user/cancelAuctionE', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: bookId })
      })
      .then(r=>r.json())
      .then(fetchBookDetails)
      .catch(console.error);
    }

    // Other functions
    function editBook() {
      window.location.href = `/editBook?id=${bookId}&email=${encodeURIComponent(currentUserEmail)}`;
    }
    function removeBook() {
      if (!confirm('Remove this book?')) return;
      fetch(`/user/removeBook?id=${bookId}&email=${encodeURIComponent(currentUserEmail)}`, { method:'DELETE' })
        .then(r=>r.json())
        .then(()=>{
          alert('Book removed successfully');
          window.location.href = `/myBooks?email=${encodeURIComponent(currentUserEmail)}`;
        })
        .catch(console.error);
    }
    function goBack() {
      window.location.href = `/myBooks?email=${encodeURIComponent(currentUserEmail)}`;
    }

    // Auto-refresh
    setInterval(fetchBookDetails, 10000);
    fetchBookDetails();
  </script>
</body>
</html>
