<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Activity - BookVerse</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/user.css">
  <style>
     
    .notification-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .notification-card {
      position: relative;
      background: white;
      border-radius: 8px;
      padding: 15px 15px 25px 40px; /* leave space on left for delete icon */
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .notification-card .delete-btn {
      position: absolute;
      top: 10px;
      right: 40px;
      background: transparent;
      border: none;
      font-size: 30px;
      color: rgb(172, 25, 25);
      cursor: pointer;
    }
    .notification-card .timestamp {
      position: absolute;
      bottom: 10px;
      left: 40px;
      font-size: 10px;
      color: #888;
    }
    .notification-card p {
      margin: 0;
      font-size: 17px;
      color: #4d4848;
    }
    h2 {
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">BookVerse</div>
    <img src="user.jpg" alt="Profile" class="profile-pic" onclick="toggleSidebarRight()">
  </header>

  <!-- Right Sidebar -->
  <div class="sidebar-right" id="sidebarRight">
    <button class="close-sidebar-right" onclick="toggleSidebarRight()">
      <i class="fas fa-arrow-right"></i>
    </button>
    <div class="profile-container">
      <img src="/user.jpg" alt="Profile" id="sidebarProfilePic" class="sidebar-profile-pic">
    </div>
    <h2 id="userNameHeader"></h2>
    <ul>
      <li onclick="navigateTo('dashboard')">Home</li>
      <li onclick="navigateTo('myBooks')">My Books</li>
      <li onclick="navigateTo('uploadStudyMaterials')">Upload Study Materials</li>
      <li onclick="navigateTo('Notifications')">Notifications</li>
      <li onclick="navigateTo('profile')">Profile</li>
      <li onclick="logout()">Logout</li>
    </ul>
  </div>

  <!-- Main Content -->
  <main class="content">
    <h2>My Notifications</h2>
    <div id="NotificationList">
      <!-- notification feed goes here -->
      <!-- Pending notification cards will be populated here -->
    </div>
    
  </main>

  <script>
    function toggleSidebarRight() {
      document.getElementById('sidebarRight').classList.toggle('active');
    }
    function navigateTo(page) {
    const base = `/${page}`;
    const query = currentUserEmail
      ? `?email=${encodeURIComponent(currentUserEmail)}`
      : '';
    window.location.href = base + query;
  }
  const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('id');
    const currentUserEmail = urlParams.get('email');
    function logout() {
      window.location.href = '/login.html';
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      fetch(`/user/me?email=${encodeURIComponent(currentUserEmail)}`)
        .then(response => response.json())
        .then(data => {
          // Compute the image URL or fallback to default
      const picUrl = data.profile_picture
        ? `/uploads/profile_pics/${data.profile_picture}`
        : '/user.jpg';

      // Update header profile pic (the one with class="profile-pic")
      const headerPic = document.querySelector('.profile-pic');
      if (headerPic) headerPic.src = picUrl;

      // Update sidebar profile pic
      const sidebarPic = document.getElementById('sidebarProfilePic');
      if (sidebarPic) sidebarPic.src = picUrl;
          document.getElementById("userNameHeader").textContent = data.full_name;
        })
        .catch(error => {
          console.error('Error fetching user info:', error);
          document.getElementById("userNameHeader").textContent = "User";
        });
    });
    document.addEventListener("DOMContentLoaded", function() {
      fetch(`/user/me?email=${encodeURIComponent(currentUserEmail)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById("userNameHeader").textContent = data.full_name;
        })
        .catch(error => {
          console.error('Error fetching user info:', error);
          document.getElementById("userNameHeader").textContent = "User";
        });
    });
    // Load notifications for the current user
    function loadNotifications() {
      fetch(`/user/notifications?email=${encodeURIComponent(currentUserEmail)}`)
        .then(response => response.json())
        .then(data => {
          const list = document.getElementById("NotificationList");
          list.innerHTML = "";
          if (Array.isArray(data) && data.length === 0) {
            list.innerHTML = "<p>No New Notifications</p>";
          } else if (Array.isArray(data)) {
            data.forEach(notification => {
              // Format timestamp to a readable string
              const timestamp = new Date(notification.notification_generated_time).toLocaleString();
              list.innerHTML += `
                <div class="notification-card" id="notification_${notification.id}">
                  <button class="delete-btn" onclick="deleteNotification(${notification.id})">X</button>
                  <p><strong>${notification.notification}</strong></p>
                  <div class="timestamp">${timestamp}</div>
                </div>
              `;
            });
          } else {
            list.innerHTML = "<p>Error: Unexpected data format.</p>";
          }
        })
        .catch(err => {
          console.error('Error fetching notifications:', err);
          document.getElementById("NotificationList").innerHTML = "<p>Error fetching notifications.</p>";
        });
    }
     // Delete a notification by ID
     function deleteNotification(notificationId) {
      if (confirm("Are you sure you want to delete this notification?")) {
        fetch(`/user/notifications/${notificationId}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            // Remove the notification card from the DOM
            const card = document.getElementById(`notification_${notificationId}`);
            if (card) {
              card.remove();
            }
          })
          .catch(err => console.error('Error deleting notification:', err));
      }
    }

    document.addEventListener("DOMContentLoaded", loadNotifications);

  </script>
</body>
</html>
